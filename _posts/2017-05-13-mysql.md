---
layout: post
title: 'Mysql'
categories: mysql
---

``MySql`` 处理请求的全过程分为 5 步:

- 连接器: 当客户端登录的时候，对身份认证和权限进行判断
- 查询缓存: 执行查询语句的时候，会先查询缓存(8.0 版本以后移除)
- 分析器: 假设在没有命中的查询缓存的情况下,sql 请求就会来到分析器,分析器负责检查 Sql 语句是否正确,明确 Sql 要完成的功能.
- 优化器: 为 sql 提供优化执行的方案. 例如:选择使用哪个索引、多表关联(join)选择表的连接顺序
- 执行器: 将语句分发到执行引擎执行，返回结果.

  可以使用 ``show processlist`` 命令查询连接状态,其中 ``Command`` 含义如下:
  Command|含义
  ------|------
  Query|正在执行的查询
  Sleep|空闲连接，等待客户端发送请求
  locked|正在等待表锁的释放
  sorting result|正在对结果进行排序
  sending data|向客户端返回数据

  连接分为长连接和短连接:

- 长连接是指连接成功后，客户端请求一直使用这个连接
- 短连接是指每次执行完 sql 请求操作的时候都会断开连接，下次 sql 请求会重新建立连接.
  - 由于短连接一直反复创建连接消耗资源,因此大多数情况下建议选择长连接.但是保持长连接会占用系统内存,被占有的内存等到连接断开后才会释放.有两个解决方案:
  - 定期断开长连接，每隔一段时间或者执行一个占用内存大的查询以后断开连接，从而释放内存，当查询的时候再重新创建连接.
  - 5.7 或者更高的版本，通过执行``mysql_reset_connection``来重新初始化连接。此过程不会重新建立连接，但是会释放占用的内存，将连接恢复到刚刚创立连接的状态
